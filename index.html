<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Perekam & Penerjemah</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        :root {
            --primary: #6366f1;
            /* ungu elegan */
            --accent: #7c3aed;
            --danger: #ef4444;
            --muted: #6b7280;
            --bg: #f8fafc;
            --card: #ffffff;
        }

        html,
        body {
            height: 100%
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
            background: linear-gradient(180deg, var(--bg) 0%, #f3f4f6 100%);
            margin: 0;
            /* MOBILE OPTIMIZATION: Kurangi padding di body untuk layar kecil */
            padding: 12px;
            -webkit-font-smoothing: antialiased;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            min-height: 100vh;
        }

        .app {
            width: 100%;
            max-width: 900px;
            background: var(--card);
            border-radius: 14px;
            /* MOBILE OPTIMIZATION: Kurangi padding di container utama untuk layar kecil */
            padding: 16px;
            box-shadow: 0 10px 30px rgba(2, 6, 23, 0.06);
            border: 1px solid rgba(15, 23, 42, 0.04);
        }

        .record-dot {
            width: 12px;
            height: 12px;
            border-radius: 9999px;
            background: var(--danger);
            opacity: 0;
            transform: scale(1)
        }

        @keyframes pulse {
            0% {
                transform: scale(1)
            }

            50% {
                transform: scale(1.35)
            }

            100% {
                transform: scale(1)
            }
        }

        .is-recording .record-dot {
            opacity: 1;
            animation: pulse 1s infinite
        }

        .loading {
            border: 4px solid rgba(0, 0, 0, 0.08);
            border-top: 4px solid var(--primary);
            border-radius: 9999px;
            width: 28px;
            height: 28px;
            animation: spin 1s linear infinite
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg)
            }

            100% {
                transform: rotate(360deg)
            }
        }

        .truncate-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden
        }

        .btn {
            transition: all .12s ease;
            box-shadow: 0 6px 18px rgba(99, 102, 241, 0.08)
        }

        .btn:active {
            transform: translateY(1px)
        }

        /* Custom Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: var(--card);
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            /* Sedikit lebih lebar untuk menampung teks */
            width: 100%;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            animation: modalFadeIn 0.3s ease-out;
            max-height: 80vh;
            /* Batasi tinggi modal */
            overflow-y: auto;
            /* Tambahkan scroll jika konten terlalu panjang */
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 12px;
        }

        .modal-message {
            color: #475569;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* MOBILE OPTIMIZATION: Tombol di modal jadi full-width di layar kecil */
        @media (max-width: 480px) {
            .modal-actions {
                flex-direction: column-reverse;
            }

            .modal-actions button {
                width: 100%;
            }
        }

        /* responsive tweaks for desktop */
        @media(min-width:768px) {

            /* Kembalikan padding ke ukuran asli untuk desktop */
            body {
                padding: 28px
            }

            .app {
                padding: 24px
            }
        }
    </style>
</head>

<body>
    <main class="app" id="appRoot" role="main" aria-label="Perekam dan Penerjemah">
        <header class="mb-4">
            <h1 class="text-2xl font-semibold text-slate-800">Perekam Suara & Penerjemah</h1>
            <p class="text-sm text-slate-500 mt-1">Tema: <strong>Ungu Elegan</strong>. Rekaman tersimpan lokal
                (LocalStorage).</p>
        </header>

        <!-- Recorder Card -->
        <section class="mb-5 p-4 rounded-lg border border-gray-100 bg-white">
            <div class="flex items-start justify-between">
                <div>
                    <h2 class="text-lg font-semibold text-slate-800">Perekam</h2>
                    <p class="text-sm text-slate-500 mt-1">Tekan untuk mulai/berhenti. Rekaman otomatis disimpan ke
                        browser.</p>
                </div>
                <div class="flex items-center gap-3">
                    <div class="record-dot" id="recording-ind"></div>
                    <div id="statusMessage" class="text-sm text-slate-500" aria-live="polite"></div>
                </div>
            </div>

            <div class="mt-4 flex flex-col sm:flex-row gap-3">
                <button id="recordButton"
                    class="btn bg-[color:var(--primary)] hover:bg-[color:var(--accent)] text-white font-semibold py-3 px-5 rounded-full w-full">
                    <span id="recordLabel">Mulai Merekam</span>
                </button>

                <button id="stopButton"
                    class="btn bg-gray-100 text-slate-700 font-medium py-3 px-4 rounded-full w-full hidden">Stop</button>

                <button id="showSavedButton"
                    class="btn bg-white border border-gray-200 text-slate-700 font-medium py-3 px-4 rounded-full w-full">Lihat
                    Rekaman</button>
            </div>

            <div class="mt-4">
                <audio id="audioPlayback" controls class="w-full rounded-md hidden" preload="metadata"></audio>
                <div class="mt-3 flex gap-2">
                    <button id="downloadButton"
                        class="btn bg-white border border-gray-200 text-slate-700 py-2 px-3 rounded w-full hidden">Unduh</button>
                    <button id="saveLocalButton"
                        class="btn bg-white border border-gray-200 text-slate-700 py-2 px-3 rounded w-full hidden">Simpan
                        Lokal</button>
                    <div style="flex:1"></div>
                </div>
            </div>

            <p class="mt-3 text-xs text-slate-500">Catatan: LocalStorage memiliki batas. Untuk rekaman panjang gunakan
                IndexedDB di masa depan.</p>
        </section>

        <!-- Transkripsi Card -->
        <section class="mb-5 p-4 rounded-lg border border-gray-100 bg-white">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-slate-800 flex items-center gap-2">
                    Hasil Transkripsi
                    <!-- TRANSCRIPTION FIX: Tambahkan ikon info untuk penjelasan -->
                    <button id="transcriptionInfoBtn" class="text-slate-400 hover:text-slate-600"
                        aria-label="Info transkripsi">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </button>
                </h2>
                <button id="clearTransButton" class="text-xs text-slate-500 hover:underline">Bersihkan</button>
            </div>
            <div id="transcribedText" class="mt-3 min-h-[120px] p-3 bg-gray-50 rounded text-slate-800">
                <p class="italic text-slate-400">Teks transkripsi akan muncul di sini saat Anda merekam (jika browser
                    mendukung SpeechRecognition).</p>
            </div>
        </section>

        <!-- Translate Card -->
        <section class="mb-5 p-4 rounded-lg border border-gray-100 bg-white">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-slate-800">Terjemahkan (Argos / Google Translate Fallback)</h2>
                <div id="translateInfo" class="text-sm text-slate-500">Source: <em>auto-detect</em></div>
            </div>

            <div class="mt-3 grid gap-3">
                <label class="text-sm text-slate-600">Bahasa tujuan</label>
                <select id="languageSelect" class="p-2 rounded border">
                    <option value="en">Bahasa Inggris (en)</option>
                    <option value="id" selected>Bahasa Indonesia (id)</option>
                    <option value="es">Bahasa Spanyol (es)</option>
                    <option value="fr">Bahasa Prancis (fr)</option>
                    <option value="de">Bahasa Jerman (de)</option>
                    <option value="ja">Bahasa Jepang (ja)</option>
                    <option value="zh">Mandarin (zh)</option>
                </select>

                <div class="flex items-center gap-3">
                    <button id="translateButton"
                        class="btn bg-[color:var(--primary)] hover:bg-[color:var(--accent)] text-white font-semibold py-3 px-4 rounded-full flex-1"
                        disabled>Terjemahkan Teks</button>
                    <div id="translateLoading" class="hidden">
                        <div class="loading" role="status" aria-hidden="true"></div>
                    </div>
                </div>

                <div id="translatedText" class="min-h-[100px] p-3 bg-gray-50 rounded text-slate-800">
                    <p class="italic text-slate-400">Hasil terjemahan akan muncul di sini.</p>
                </div>
            </div>
        </section>

        <!-- Saved recordings (modal-like area toggled) -->
        <section id="savedPanel" class="mb-0 p-4 rounded-lg border border-gray-100 bg-white" style="display:none;">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold text-slate-800">Daftar Rekaman Tersimpan</h3>
                <div class="flex items-center gap-2">
                    <button id="exportAll" class="text-xs text-slate-500 hover:underline">Backup (.json)</button>
                    <button id="clearAllButton"
                        class="btn bg-[color:var(--danger)] text-white text-sm py-2 px-3 rounded">Hapus Semua</button>
                    <button id="closeSavedBtn"
                        class="btn bg-white border border-gray-200 text-slate-700 text-sm py-2 px-3 rounded">Tutup</button>
                </div>
            </div>

            <div id="savedList" class="mt-4 space-y-3 text-slate-700">
                <!-- injected -->
            </div>

            <p id="storageWarning" class="text-sm text-yellow-700 mt-3"></p>
        </section>

        <!-- Help & Info Panel -->
        <section id="helpPanel" class="mb-0 p-4 rounded-lg border border-gray-100 bg-white" style="display:none;">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-slate-800">Bantuan & Informasi</h3>
                <button id="closeHelpBtn" class="text-slate-500 hover:text-slate-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="space-y-4 text-sm text-slate-700">
                <div>
                    <h4 class="font-semibold mb-1">üöÄ Cara Penggunaan</h4>
                    <ol class="list-decimal list-inside space-y-1 text-slate-600">
                        <li>Klik <strong>"Mulai Merekam"</strong> dan izinkan akses mikrofon.</li>
                        <li>Ucapkan kata-kata yang ingin Anda rekam.</li>
                        <li>Klik lagi untuk berhenti. Hasil rekaman dan transkripsi akan muncul.</li>
                        <li>Anda bisa <strong>memutar ulang</strong>, <strong>mengunduh</strong>, atau
                            <strong>menerjemahkan</strong> teksnya.</li>
                        <li>Klik <strong>"Lihat Rekaman"</strong> untuk mengelola semua rekaman Anda.</li>
                    </ol>
                </div>
                <div>
                    <h4 class="font-semibold mb-1">üíæ Penyimpanan Data (Penting!)</h4>
                    <p class="text-slate-600">Semua rekaman dan transkripsi <strong>hanya tersimpan di browser
                            ini</strong> (misal: Chrome di laptop Anda) menggunakan fitur <em>LocalStorage</em>.</p>
                    <ul class="list-disc list-inside mt-1 space-y-1 text-slate-600">
                        <li>Data <strong>tidak</strong> tersimpan di server atau cloud.</li>
                        <li>Data <strong>tidak akan</strong> muncul jika Anda buka di browser lain (misal: Firefox) atau
                            di perangkat lain (misal: HP).</li>
                        <li>Jika Anda menghapus data browser, semua rekaman akan hilang. Gunakan tombol <strong>"Backup
                                (.json)"</strong> untuk menyimpan salinannya.</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold mb-1">üõ†Ô∏è Fitur Lainnya</h4>
                    <ul class="list-disc list-inside space-y-1 text-slate-600">
                        <li><strong>Play Ulang:</strong> Dengarkan kembali rekaman suara.</li>
                        <li><strong>Unduh Audio:</strong> Simpan rekaman sebagai file <code>.wav</code> di perangkat
                            Anda.</li>
                        <li><strong>Lihat Transkrip:</strong> Teks hasil percakapan otomatis tersimpan.</li>
                        <li><strong>Terjemahan:</strong> Terjemahkan teks ke berbagai bahasa dengan cepat.</li>
                    </ul>
                </div>
                <!-- TRANSCRIPTION FIX: Tambahkan bagian troubleshooting -->
                <div>
                    <h4 class="font-semibold mb-1 text-red-600">üîß Troubleshooting: Transkripsi Tidak Muncul?</h4>
                    <p class="text-slate-600">Jika fitur transkripsi tidak bekerja, terutama di HP, kemungkinan ada 2
                        masalah utama:</p>
                    <ol class="list-decimal list-inside mt-1 space-y-2 text-slate-600">
                        <li><strong>Izin Mikrofon Ditolak:</strong> Pastikan Anda mengklik "Izinkan" saat browser
                            meminta akses mikrofon. Periksa pengaturan privasi browser Anda.</li>
                        <li><strong>Koneksi Tidak Aman (Paling Umum):</strong> Fitur ini <strong>WAJIB</strong> berjalan
                            di lingkungan aman (HTTPS). Jika Anda membuka file langsung dari komputer (alamatnya dimulai
                            dengan <code>file://</code>), fitur ini akan gagal.
                            <br><strong>Solusi:</strong> Gunakan server lokal (seperti Live Server di VS Code) atau
                            hosting file ini di platform seperti GitHub Pages, Netlify, atau Vercel agar memiliki alamat
                            <code>https://</code>.
                        </li>
                    </ol>
                </div>
            </div>
        </section>

        <footer class="mt-4 text-xs text-slate-500 text-center">
            <div class="mb-2">Key LocalStorage: <code>rekamanSuara</code></div>
            <div class="font-semibold text-slate-700">Dibuat oleh <span class="text-[color:var(--primary)]">Alvan Sheikh
                    Wardana</span> ‚Äî Ini adalah karya pribadi, bukan hasil tiruan atau pengambilan kode dari orang lain.
            </div>
        </footer>
    </main>

    <!-- Custom Modal -->
    <div id="customModal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modalTitle" class="modal-title"></h3>
            <p id="modalMessage" class="modal-message"></p>
            <div id="modalActions" class="modal-actions">
                <!-- Buttons will be injected here -->
            </div>
        </div>
    </div>

    <script>
        /* ============================
           Mobile-first single-column app
           Theme: Ungu (#6366f1)
           Translate: https://translate.argosopentech.com/translate (Primary)
                      https://translate.googleapis.com/translate_a/single (Fallback)
           LocalStorage key: rekamanSuara
           ============================ */

        const STORAGE_KEY = 'rekamanSuara';
        const TRANSLATE_ENDPOINT = 'https://translate.argosopentech.com/translate';
        const GOOGLE_TRANSLATE_ENDPOINT = 'https://translate.googleapis.com/translate_a/single';

        // DOM
        const recordButton = document.getElementById('recordButton');
        const recordLabel = document.getElementById('recordLabel');
        const stopButton = document.getElementById('stopButton');
        const audioPlayback = document.getElementById('audioPlayback');
        const transcribedTextDiv = document.getElementById('transcribedText');
        const translatedTextDiv = document.getElementById('translatedText');
        const languageSelect = document.getElementById('languageSelect');
        const translateButton = document.getElementById('translateButton');
        const translateLoading = document.getElementById('translateLoading');
        const statusMessage = document.getElementById('statusMessage');
        const recordingDot = document.getElementById('recording-ind');
        const downloadButton = document.getElementById('downloadButton');
        const saveLocalButton = document.getElementById('saveLocalButton');
        const showSavedButton = document.getElementById('showSavedButton');
        const savedPanel = document.getElementById('savedPanel');
        const savedList = document.getElementById('savedList');
        const closeSavedBtn = document.getElementById('closeSavedBtn');
        const clearAllButton = document.getElementById('clearAllButton');
        const storageWarning = document.getElementById('storageWarning');
        const clearTransButton = document.getElementById('clearTransButton');
        const exportAllBtn = document.getElementById('exportAll');

        // New DOM elements
        const helpPanel = document.getElementById('helpPanel');
        const closeHelpBtn = document.getElementById('closeHelpBtn');
        const customModal = document.getElementById('customModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalActions = document.getElementById('modalActions');
        const transcriptionInfoBtn = document.getElementById('transcriptionInfoBtn');

        // State
        let mediaRecorder = null;
        let speechRecognition = null;
        let isRecording = false;
        let audioChunks = [];
        let audioBlob = null;
        let finalTranscript = '';
        let interimTranscript = '';

        // SpeechRecognition support
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            statusMessage.textContent = 'Browser ini tidak mendukung SpeechRecognition.';
        }

        // --- Custom Modal Functions ---
        function hideModal() {
            customModal.style.display = 'none';
        }

        function showAlert(title, message) {
            modalTitle.innerHTML = title;
            modalMessage.innerHTML = message;
            modalActions.innerHTML = `<button class="btn bg-[color:var(--primary)] text-white px-4 py-2 rounded-full">Oke</button>`;
            modalActions.querySelector('button').onclick = hideModal;
            customModal.style.display = 'flex';
        }

        function showConfirm(title, message) {
            return new Promise((resolve) => {
                modalTitle.textContent = title;
                modalMessage.innerHTML = message;
                modalActions.innerHTML = `
                    <button id="confirmCancel" class="btn bg-white border border-gray-200 text-slate-700 px-4 py-2 rounded-full">Batal</button>
                    <button id="confirmOk" class="btn bg-[color:var(--danger)] text-white px-4 py-2 rounded-full">Oke</button>
                `;

                document.getElementById('confirmOk').onclick = () => {
                    hideModal();
                    resolve(true);
                };
                document.getElementById('confirmCancel').onclick = () => {
                    hideModal();
                    resolve(false);
                };
                customModal.style.display = 'flex';
            });
        }

        // TRANSCRIPTION FIX: Fungsi khusus untuk modal info transkripsi
        function showTranscriptionInfoModal() {
            const title = 'Persyaratan Fitur Transkripsi';
            const message = `
                <p>Agar fitur transkripsi suara berkerja dengan baik, pastikan:</p>
                <ul class="list-disc list-inside mt-2 space-y-1">
                    <li>Browser Anda mendukung <strong>SpeechRecognition</strong> (Chrome/Edge terbaik).</li>
                    <li>Anda <strong>memberikan izin mikrofon</strong> saat diminta.</li>
                    <li>Aplikasi dibuka melalui koneksi aman <strong>HTTPS</strong>, bukan <code>file://</code>. Jika dibuka dari file lokal, fitur ini tidak akan berfungsi.</li>
                </ul>
            `;
            showAlert(title, message);
        }

        // Utilities
        function formatTimestamp(ts) {
            const d = new Date(ts);
            return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0')
                + ' ' + String(d.getHours()).padStart(2, '0') + ':' + String(d.getMinutes()).padStart(2, '0') + ':' + String(d.getSeconds()).padStart(2, '0');
        }

        function blobToDataURL(blob) {
            return new Promise((res, rej) => {
                const r = new FileReader();
                r.onload = () => res(r.result);
                r.onerror = e => rej(e);
                r.readAsDataURL(blob);
            });
        }

        // LocalStorage helpers
        function loadSavedRecordings() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                return raw ? JSON.parse(raw) : [];
            } catch (e) {
                console.warn(e);
                return [];
            }
        }
        function saveSavedRecordings(arr) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
                return true;
            } catch (e) {
                console.error('save error', e);
                return false;
            }
        }

        // Render saved list
        function renderSavedList() {
            const list = loadSavedRecordings();
            savedList.innerHTML = '';
            storageWarning.textContent = '';

            if (!list.length) {
                savedList.innerHTML = '<p class="text-slate-500 italic">Belum ada rekaman tersimpan.</p>';
                return;
            }

            // newest first
            list.slice().reverse().forEach(item => {
                const el = document.createElement('div');
                el.className = 'p-3 border border-gray-100 rounded flex flex-col gap-2 bg-white';
                el.innerHTML = `
        <div class="flex items-start justify-between gap-3">
          <div class="min-w-0 flex-1">
            <div class="font-medium text-slate-800 truncate">${item.name}</div>
            <div class="text-xs text-slate-500">${formatTimestamp(item.timestamp)} ‚Ä¢ ${item.duration ? item.duration + 's' : ''} ‚Ä¢ ${Math.round(item.size / 1024)} KB</div>
          </div>
          <div class="flex items-center gap-1">
            <button class="playBtn btn bg-[color:var(--primary)] text-white text-xs py-1.5 px-2.5 rounded">Play</button>
            <button class="dlBtn btn bg-white border border-gray-200 text-xs py-1.5 px-2.5 rounded">Unduh</button>
            <button class="delBtn btn bg-[color:var(--danger)] text-white text-xs py-1.5 px-2.5 rounded">Hapus</button>
          </div>
        </div>
        <div class="text-sm text-slate-700 truncate-2">${item.transcript || '<em class="text-slate-400">Tidak ada transkrip</em>'}</div>
      `;

                // wire events
                el.querySelector('.playBtn').onclick = () => {
                    audioPlayback.src = item.dataUrl; audioPlayback.style.display = 'block'; audioPlayback.play();
                    statusMessage.textContent = `Memutar: ${item.name}`;
                };
                el.querySelector('.dlBtn').onclick = () => {
                    const a = document.createElement('a'); a.href = item.dataUrl; a.download = `${item.name}.wav`; document.body.appendChild(a); a.click(); a.remove();
                };
                el.querySelector('.delBtn').onclick = async () => {
                    if (await showConfirm('Konfirmasi Hapus', `Hapus rekaman "${item.name}"?`)) {
                        let arr = loadSavedRecordings(); arr = arr.filter(i => i.id !== item.id); saveSavedRecordings(arr); renderSavedList();
                    }
                };

                savedList.appendChild(el);
            });
        }

        // Toggle saved panel
        showSavedButton.addEventListener('click', () => {
            savedPanel.style.display = 'block';
            renderSavedList();
            savedPanel.scrollIntoView({ behavior: 'smooth' });
        });
        closeSavedBtn.addEventListener('click', () => {
            savedPanel.style.display = 'none';
        });
        clearAllButton.addEventListener('click', async () => {
            if (await showConfirm('Konfirmasi Hapus Semua', 'Hapus semua rekaman dari browser ini? Tindakan ini tidak dapat dibatalkan.')) {
                localStorage.removeItem(STORAGE_KEY);
                renderSavedList();
                showAlert('Berhasil', 'Semua rekaman telah dihapus.');
            }
        });

        // Export/Backup (.json)
        exportAllBtn.addEventListener('click', () => {
            const arr = loadSavedRecordings();
            if (!arr.length) { showAlert('Info', 'Tidak ada rekaman untuk dibackup.'); return; }
            const data = JSON.stringify(arr);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `rekaman-backup-${new Date().toISOString()}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
            showAlert('Backup Berhasil', 'File backup (.json) telah diunduh.');
        });

        // Help Panel Toggle
        closeHelpBtn.addEventListener('click', () => {
            helpPanel.style.display = 'none';
        });

        // TRANSCRIPTION FIX: Tambahkan event listener untuk tombol info
        transcriptionInfoBtn.addEventListener('click', showTranscriptionInfoModal);

        // Recording logic
        async function startRecording() {
            // TRANSCRIPTION FIX: Pemeriksaan HTTPS yang lebih jelas dan solutif
            if (location.protocol === 'file:') {
                const title = '‚ö†Ô∏è Aplikasi Harus Dijalankan di Server';
                const message = `
                    <p class="mb-3">Fitur transkripsi dan perekaman <strong>WAJIB</strong> dijalankan melalui koneksi aman (HTTPS). Membuka file langsung dari komputer (alamat <code>file://</code>) tidak akan berfungsi.</p>
                    <p class="font-semibold mb-2">‚úÖ Solusi Paling Mudah (Host Online Gratis):</p>
                    <ol class="list-decimal list-inside space-y-1 text-sm mb-4">
                        <li>Buka <a href="https://app.netlify.com/drop" target="_blank" class="text-blue-600 underline">Netlify Drop</a> di browser komputer Anda.</li>
                        <li><strong>Drag dan drop</strong> seluruh folder proyek Anda ke halaman tersebut.</li>
                        <li>Netlify akan memberikan Anda alamat website (contoh: <code>https://random-name.netlify.app</code>).</li>
                        <li>Buka alamat tersebut di HP Anda. Semua fitur akan berjalan normal.</li>
                    </ol>
                    <p class="font-semibold">Solusi Alternatif (Server Lokal):</p>
                    <p class="text-sm">Jika Anda hanya ingin mencoba di Wi-Fi rumah, Anda bisa menggunakan server lokal. Ini sedikit lebih teknis. <a href="https://www.google.com/search?q=how+to+run+local+web+server" target="_blank" class="text-blue-600 underline">Cari panduan "run local web server" di Google.</a></p>
                `;
                showAlert(title, message);
                return;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioChunks = [];
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                let startTime = Date.now();

                // SpeechRecognition setup
                if (SpeechRecognition) {
                    speechRecognition = new SpeechRecognition();
                    speechRecognition.lang = 'id-ID';
                    speechRecognition.continuous = true;
                    speechRecognition.interimResults = true;
                    finalTranscript = ''; interimTranscript = '';
                    speechRecognition.onresult = (ev) => {
                        let interim = '';
                        for (let i = ev.resultIndex; i < ev.results.length; ++i) {
                            if (ev.results[i].isFinal) finalTranscript += ev.results[i][0].transcript + ' ';
                            else interim += ev.results[i][0].transcript;
                        }
                        transcribedTextDiv.innerHTML = `<p>${(finalTranscript || interim) || '<em class="text-slate-400">Tidak ada transkrip</em>'}</p>`;
                        translateButton.disabled = !((finalTranscript || interim).trim().length > 0);
                    };
                    speechRecognition.onerror = (e) => {
                        console.warn('speech error', e);
                        // TRANSCRIPTION FIX: Pesan error yang lebih spesifik
                        if (e.error === 'not-allowed') {
                            showAlert('Izin Ditolak', 'Akses mikrofon ditolak. Silakan periksa pengaturan izin browser Anda dan izinkan mikrofon untuk situs ini.');
                        } else {
                            statusMessage.textContent = 'Kesalahan transkripsi: ' + (e.error || e.message);
                        }
                    };
                    speechRecognition.onend = () => { if (isRecording && speechRecognition) { try { speechRecognition.start(); } catch (e) { } } };
                    try {
                        speechRecognition.start();
                    } catch (e) {
                        console.warn('start recognition failed', e);
                        // TRANSCRIPTION FIX: Tangkap error saat start() dipanggil
                        showAlert('Gagal Memulai Transkripsi', 'Tidak dapat memulai mesin transkripsi. Pastikan Anda menggunakan browser yang mendukung (seperti Chrome) dan membuka halaman ini melalui HTTPS.');
                    }
                }

                mediaRecorder.onstop = async () => {
                    audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const durationSec = Math.round((Date.now() - startTime) / 1000);
                    const dataUrl = await blobToDataURL(audioBlob);
                    audioPlayback.src = dataUrl; audioPlayback.style.display = 'block';
                    downloadButton.style.display = 'inline-block';
                    saveLocalButton.style.display = 'inline-block';
                    document.body.classList.remove('is-recording');
                    statusMessage.textContent = 'Perekaman selesai dan disimpan otomatis.';
                    // Auto-save
                    const item = {
                        id: 'r' + Date.now(),
                        name: `Rekaman - ${formatTimestamp(Date.now())}`,
                        timestamp: Date.now(),
                        duration: durationSec,
                        size: audioBlob.size,
                        transcript: finalTranscript.trim(),
                        dataUrl
                    };
                    const arr = loadSavedRecordings(); arr.push(item);
                    const ok = saveSavedRecordings(arr);
                    if (!ok) storageWarning.textContent = 'Gagal menyimpan otomatis (quota mungkin penuh). Silakan unduh sebagai cadangan.';
                    else storageWarning.textContent = '';
                    renderSavedList();
                };

                mediaRecorder.start();
                isRecording = true;
                document.body.classList.add('is-recording');
                recordLabel.textContent = 'Merekam... Klik lagi untuk berhenti';
                recordButton.classList.add('bg-[color:var(--danger)]');
                stopButton.classList.remove('hidden');
                statusMessage.textContent = 'Merekam...';
            } catch (err) {
                console.error('startRecording error', err);
                // TRANSCRIPTION FIX: Pesan error yang lebih jelas untuk mikrofon
                if (err.name === 'NotAllowedError') {
                    showAlert('Izin Mikrofon Diperlukan', 'Anda harus mengizinkan akses mikrofon untuk menggunakan fitur ini. Silakan segarkan halaman dan berikan izin saat diminta.');
                } else {
                    showAlert('Kesalahan', 'Tidak dapat mengakses mikrofon. Pastikan perangkat memiliki mikrofon dan izin telah diberikan.');
                }
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
            if (speechRecognition) { try { speechRecognition.stop(); } catch (e) { } speechRecognition = null; }
            isRecording = false;
            recordLabel.textContent = 'Mulai Merekam';
            recordButton.classList.remove('bg-[color:var(--danger)]');
            stopButton.classList.add('hidden');
            translateButton.disabled = !((finalTranscript || '').trim().length > 0);
        }

        // Buttons
        recordButton.addEventListener('click', () => { if (isRecording) stopRecording(); else startRecording(); });
        stopButton.addEventListener('click', stopRecording);

        // Download current audio (if any)
        downloadButton.addEventListener('click', () => {
            if (!audioPlayback.src) return;
            const a = document.createElement('a'); a.href = audioPlayback.src; a.download = `rekaman-${new Date().toISOString()}.wav`; document.body.appendChild(a); a.click(); a.remove();
        });

        // Manual save (redundant since auto-save runs on stop)
        saveLocalButton.addEventListener('click', async () => {
            if (!audioBlob) { showAlert('Info', 'Belum ada rekaman.'); return; }
            try {
                const dataUrl = await blobToDataURL(audioBlob);
                const item = {
                    id: 'r' + Date.now(),
                    name: `Rekaman - ${formatTimestamp(Date.now())}`,
                    timestamp: Date.now(),
                    duration: null,
                    size: audioBlob.size,
                    transcript: finalTranscript.trim(),
                    dataUrl
                };
                const arr = loadSavedRecordings(); arr.push(item);
                const ok = saveSavedRecordings(arr);
                if (!ok) showAlert('Gagal Menyimpan', 'Gagal menyimpan (kuota mungkin penuh). Silakan unduh sebagai cadangan.');
                else { renderSavedList(); showAlert('Berhasil', 'Tersimpan ke LocalStorage browser ini.'); }
            } catch (e) { console.error(e); showAlert('Kesalahan', 'Gagal menyimpan: ' + e.message); }
        });

        // Clear transcription
        clearTransButton.addEventListener('click', () => { finalTranscript = ''; interimTranscript = ''; transcribedTextDiv.innerHTML = '<p class="italic text-slate-400">Teks transkripsi dibersihkan.</p>'; translateButton.disabled = true; });

        // Translate using Argos (primary) with fallback to Google Translate
        async function translateText() {
            const text = (transcribedTextDiv.textContent || '').trim();
            const target = languageSelect.value;
            if (!text) {
                translatedTextDiv.innerHTML = '<p class="italic text-slate-400">Tidak ada teks untuk diterjemahkan.</p>';
                return;
            }

            translateButton.disabled = true;
            translateLoading.classList.remove('hidden');
            translatedTextDiv.innerHTML = '<p class="italic text-slate-500">Menerjemahkan...</p>';

            try {
                // Coba API Argos terlebih dahulu
                const payload = { q: text, source: 'auto', target, format: 'text' };
                const res = await fetch(TRANSLATE_ENDPOINT, {
                    method: 'POST',
                    mode: 'cors', // Tambahkan mode CORS
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) {
                    const txt = await res.text();
                    throw new Error(`${res.status}: ${txt}`);
                }

                const data = await res.json();
                translatedTextDiv.innerHTML = `<p>${(data.translatedText || '').replace(/\n/g, '<br>') || '<em class="text-slate-400">Terjemahan kosong</em>'}</p>`;

            } catch (err) {
                console.error('Argos translate error:', err);
                // Jika Argos gagal, coba Google Translate sebagai fallback
                try {
                    const url = `${GOOGLE_TRANSLATE_ENDPOINT}?client=gtx&sl=auto&tl=${target}&dt=t&q=${encodeURIComponent(text)}`;
                    const response = await fetch(url, {
                        method: 'GET',
                        mode: 'cors'
                    });

                    if (!response.ok) {
                        throw new Error(`Status: ${response.status}`);
                    }

                    const data = await response.json();
                    const translatedText = data[0].map(item => item[0]).join('');

                    translatedTextDiv.innerHTML = `<p>${translatedText.replace(/\n/g, '<br>')}</p>`;
                } catch (altErr) {
                    console.error('Alternative translation failed:', altErr);
                    translatedTextDiv.innerHTML = `<p class="italic text-red-600">Terjadi kesalahan saat menerjemahan. Silakan periksa koneksi internet Anda dan coba lagi.</p>`;
                }
            } finally {
                translateLoading.classList.add('hidden');
                translateButton.disabled = !((finalTranscript || '').trim().length > 0);
            }
        }
        translateButton.addEventListener('click', translateText);

        // Startup: render saved preview (and info)
        window.addEventListener('load', () => {
            const arr = loadSavedRecordings();
            if (arr.length) statusMessage.textContent = `${arr.length} rekaman tersimpan. Klik "Lihat Rekaman" untuk manajemen.`;

            // Show help panel on first visit
            if (!localStorage.getItem('hasVisitedBefore')) {
                helpPanel.style.display = 'block';
                helpPanel.scrollIntoView({ behavior: 'smooth' });
                localStorage.setItem('hasVisitedBefore', 'true');
            }

            renderSavedList();
        });

    </script>
</body>

</html>